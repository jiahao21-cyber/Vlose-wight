<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RECLAIM - 身材夺回计划</title>
    
    <!-- React 核心库 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            background-color: #09090b;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-bottom-pad { padding-bottom: calc(env(safe-area-inset-bottom) + 80px); }
        
        @keyframes energyRise {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            100% { transform: translateY(-150px) scale(0.5); opacity: 0; }
        }
        .energy-particle {
            position: absolute;
            background: radial-gradient(circle, rgba(52, 211, 153, 0.6) 0%, rgba(52, 211, 153, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            animation: energyRise 1.5s ease-out forwards;
        }
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .animate-pop-green { animation: pop 0.2s ease-out; color: #34d399; }
        .animate-pop-red { animation: pop 0.2s ease-out; color: #f87171; }
        
        /* 鸭子浮动动画 */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(2deg); }
        }
        .duck-float { animation: float 3s ease-in-out infinite; }
        
        /* 波浪动画 */
        @keyframes wave {
            0% { background-position-x: 0; }
            100% { background-position-x: 1000px; }
        }
        .wave {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%230ea5e9' fill-opacity='0.4' d='M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: repeat-x;
            background-size: 1000px 100%;
            animation: wave 20s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 0. 内置图标组件 ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Wallet = (props) => <IconBase {...props}><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4" /><path d="M4 6v12c0 1.1.9 2 2 2h14v-4" /><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z" /></IconBase>;
        const Pizza = (props) => <IconBase {...props}><path d="M15 11h.01"/><path d="M11 15h.01"/><path d="M16.5 4a21.16 21.16 0 0 1 7.6 15.6c-2.4-.6-4.8-1.2-7.1-1.2-2.3 0-4.7.6-7.1 1.2A21.16 21.16 0 0 1 2.5 4"/><path d="m10 2 6 2"/><path d="M2 4 12 21 22 4"/></IconBase>;
        const Flame = (props) => <IconBase {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1 1.2-1.7 2.3-1.7z"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></IconBase>;
        const TrendingUp = (props) => <IconBase {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></IconBase>;
        const Settings = (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconBase>;
        const Droplet = (props) => <IconBase {...props}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></IconBase>;
        const Scale = (props) => <IconBase {...props}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></IconBase>;
        const Footprints = (props) => <IconBase {...props}><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 1.25-.76 2.5-2 2.5H8a1 1 0 0 1-1-1v-1"/><path d="M16 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C10.63 6 9 7.8 9 12c0 1.25.76 2.5 2 2.5h1a1 1 0 0 1 1 1v1"/></IconBase>;
        const Fist = (props) => <IconBase {...props}><path d="M11 11V5a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2"/><path d="M7 11V6a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v4"/><path d="M3 11V7a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v4"/><path d="M19 11a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-1v4a2 2 0 0 1-2 2h-6a2 2 0 0 1-2-2v-4H7a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h1"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></IconBase>;
        const Cookie = (props) => <IconBase {...props}><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"/><path d="M8.5 8.5v.01"/><path d="M16 15.5v.01"/><path d="M12 12v.01"/><path d="M11 17v.01"/><path d="M7 14v.01"/></IconBase>;
        const TrendingDown = (props) => <IconBase {...props}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6" /><polyline points="17 18 23 18 23 12" /></IconBase>;

        // --- 橡胶鸭组件 (SVG) ---
        const RubberDuck = ({ className }) => (
            <svg viewBox="0 0 100 100" className={className} xmlns="http://www.w3.org/2000/svg">
                <path d="M70 45 C70 30, 90 30, 90 45 C90 55, 80 55, 75 55 L75 60 C85 60, 90 65, 90 70 C90 85, 60 85, 20 85 C10 85, 10 60, 20 60 C15 50, 30 45, 40 50 C40 30, 60 30, 60 45 Z" fill="#FCD34D" />
                <circle cx="78" cy="40" r="2" fill="black" />
                <path d="M85 45 L95 42 L95 48 Z" fill="#F97316" />
                <path d="M35 65 Q45 55 55 65" stroke="#F59E0B" strokeWidth="2" fill="none" />
            </svg>
        );

        // --- 1. 赛博食欲抑制组件 ---
        const CyberSuppressor = ({ onClose }) => {
            const [isActive, setIsActive] = useState(false);
            const [particles, setParticles] = useState([]);
            const intervalRef = useRef(null);
            
            useEffect(() => {
                if (isActive) {
                    intervalRef.current = setInterval(() => { if (navigator.vibrate) navigator.vibrate(50); }, 100);
                } else { clearInterval(intervalRef.current); }
                return () => clearInterval(intervalRef.current);
            }, [isActive]);

            const startAction = (e) => { e.preventDefault(); setIsActive(true); };
            const endAction = () => {
                setIsActive(false);
                const count = 8;
                const newParticles = [];
                for(let i=0; i<count; i++) {
                    newParticles.push({ id: Date.now() + i, left: 50 + (Math.random() * 40 - 20) + '%', size: 10 + Math.random() * 20 + 'px', delay: Math.random() * 0.3 + 's' });
                }
                setParticles(prev => [...prev, ...newParticles]);
            };

            useEffect(() => {
                if (particles.length > 20) {
                    const timer = setTimeout(() => { setParticles(prev => prev.slice(particles.length - 20)); }, 2000);
                    return () => clearTimeout(timer);
                }
            }, [particles]);

            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-between safe-top safe-bottom p-6 animate-in fade-in duration-300">
                    <button onClick={onClose} className="absolute top-6 right-6 text-zinc-500 p-2"><X className="w-8 h-8" /></button>
                    <div className="text-zinc-500 mt-10 text-sm tracking-widest uppercase font-mono">Cyber Appetite Suppressor</div>
                    <div className="relative w-full h-64 pointer-events-none">
                        {particles.map(p => (
                            <div key={p.id} className="energy-particle" style={{ left: p.left, width: p.size, height: p.size, animationDelay: p.delay, bottom: 0 }}></div>
                        ))}
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center w-full">
                        <div className="relative">
                            <div className={`absolute inset-0 rounded-full bg-emerald-500 blur-3xl transition-opacity duration-500 ${isActive ? 'opacity-40' : 'opacity-0'}`}></div>
                            <button onPointerDown={startAction} onPointerUp={endAction} onPointerLeave={endAction} className={`relative w-48 h-48 rounded-full border-4 flex items-center justify-center transition-all duration-300 touch-none select-none ${isActive ? 'border-emerald-400 bg-emerald-900/30 scale-95 shadow-[0_0_50px_rgba(16,185,129,0.5)]' : 'border-zinc-800 bg-zinc-900 scale-100 shadow-none'}`}>
                                <div className={`text-center transition-opacity duration-300 ${isActive ? 'opacity-100' : 'opacity-50'}`}>
                                    {isActive ? (<span className="text-emerald-400 font-bold text-xl tracking-widest animate-pulse">注入意志...</span>) : (<div className="flex flex-col items-center text-zinc-500"><Droplet className="w-8 h-8 mb-2" /><span className="text-sm">长按抑制食欲</span></div>)}
                                </div>
                            </button>
                        </div>
                        <p className="mt-8 text-zinc-600 text-xs text-center max-w-xs">通过触觉反馈转移对食物的注意力<br/>想象这是纯净的水注入身体</p>
                    </div>
                </div>
            );
        };

        // --- 2. 水力充能站 (新功能) ---
        const HydrationStation = ({ onClose, waterIntake, onDrink }) => {
            const dailyGoal = 2500; // ml
            const progress = Math.min(100, (waterIntake / dailyGoal) * 100);
            
            // 估算收益：每500ml水增加代谢约24%持续60分钟 -> 简化为分数
            // 1L水消耗约23大卡用于加热（体温）
            const metabolicBoost = Math.floor(waterIntake / 500 * 10); // 假定数值提升
            const fatMetabolismHelp = Math.floor(waterIntake * 0.03); // 辅助代谢克数

            return (
                <div className="fixed inset-0 z-50 bg-sky-950 flex flex-col safe-top safe-bottom animate-in slide-in-from-left duration-300">
                    <div className="p-4 flex justify-between items-center z-10">
                        <div className="text-sky-300 text-sm tracking-widest uppercase font-mono flex items-center gap-2">
                            <Droplet className="w-4 h-4" /> Hydration Protocol
                        </div>
                        <button onClick={onClose} className="p-2 bg-sky-900/50 rounded-full text-sky-300 hover:text-white"><X className="w-6 h-6" /></button>
                    </div>

                    {/* 鸭子泳池区域 */}
                    <div className="relative flex-1 w-full overflow-hidden flex flex-col justify-end bg-sky-900/20">
                        {/* 鸭子 */}
                        <div className="absolute w-24 h-24 duck-float z-20 left-1/2 -ml-12 transition-all duration-700 ease-out" 
                             style={{ bottom: `calc(${progress}% - 20px)` }}>
                            <RubberDuck className="w-full h-full drop-shadow-xl" />
                        </div>
                        
                        {/* 水面 */}
                        <div className="w-full bg-sky-500/80 transition-all duration-700 ease-out relative" style={{ height: `${progress}%`, minHeight: '10px' }}>
                            <div className="absolute top-0 left-0 w-full h-4 -mt-4 wave opacity-80"></div>
                            <div className="absolute top-0 left-0 w-full h-4 -mt-2 wave opacity-50" style={{ animationDuration: '15s', animationDirection: 'reverse' }}></div>
                        </div>

                        {/* 数据浮层 */}
                        <div className="absolute top-20 left-0 w-full text-center z-10">
                            <div className="text-6xl font-black text-sky-100 drop-shadow-lg">{waterIntake}<span className="text-xl font-medium text-sky-300 ml-1">ml</span></div>
                            <div className="text-sky-400 text-xs mt-1 font-bold">每日目标: {dailyGoal}ml</div>
                        </div>
                    </div>

                    {/* 收益面板 */}
                    <div className="bg-sky-950 p-6 z-10 border-t border-sky-800">
                        <div className="grid grid-cols-2 gap-3 mb-6">
                            <div className="bg-sky-900/40 p-3 rounded-xl border border-sky-800/50 flex items-center gap-3">
                                <div className="bg-sky-500/20 p-2 rounded-lg text-sky-400"><Zap className="w-5 h-5" /></div>
                                <div>
                                    <div className="text-xl font-bold text-sky-200">+{metabolicBoost}%</div>
                                    <div className="text-[10px] text-sky-400 uppercase">基础代谢提速</div>
                                </div>
                            </div>
                            <div className="bg-sky-900/40 p-3 rounded-xl border border-sky-800/50 flex items-center gap-3">
                                <div className="bg-sky-500/20 p-2 rounded-lg text-sky-400"><Activity className="w-5 h-5" /></div>
                                <div>
                                    <div className="text-xl font-bold text-sky-200">{fatMetabolismHelp}g</div>
                                    <div className="text-[10px] text-sky-400 uppercase">辅助脂肪分解</div>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-4">
                            <button onClick={() => onDrink(200)} className="flex-1 bg-sky-700 hover:bg-sky-600 active:scale-95 transition-all p-4 rounded-2xl flex flex-col items-center justify-center border border-sky-600 shadow-lg group">
                                <span className="text-xs text-sky-300 font-bold mb-1 group-hover:text-white">小口喝</span>
                                <span className="text-xl font-black text-white">+200ml</span>
                            </button>
                            <button onClick={() => onDrink(500)} className="flex-1 bg-sky-500 hover:bg-sky-400 active:scale-95 transition-all p-4 rounded-2xl flex flex-col items-center justify-center border border-sky-400 shadow-lg shadow-sky-500/20 group">
                                <span className="text-xs text-sky-100 font-bold mb-1">大口灌</span>
                                <span className="text-xl font-black text-white">+500ml</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 3. 损失报告组件 ---
        const DamageReport = ({ onClose, slipUps, itemPrice, itemCalories, onConfirmSlipUp }) => {
            const [isAnimating, setIsAnimating] = useState(false);
            
            const count = slipUps.length;
            const moneyLost = count * itemPrice;
            const caloriesIntake = count * itemCalories;
            const runDebtKm = caloriesIntake / 65;

            const handleAdd = () => {
                onConfirmSlipUp();
                setIsAnimating(true);
                setTimeout(() => setIsAnimating(false), 300);
            };

            return (
                <div className="fixed inset-0 z-50 bg-zinc-950 flex flex-col safe-top safe-bottom animate-in slide-in-from-right duration-300">
                    <div className="p-4 flex justify-between items-center border-b border-zinc-800 bg-zinc-900/50 backdrop-blur">
                        <div className="flex items-center gap-2 text-red-500">
                            <AlertCircle className="w-5 h-5" />
                            <span className="font-bold tracking-wider uppercase">摄入警报</span>
                        </div>
                        <button onClick={onClose} className="p-2 bg-zinc-800 rounded-full text-zinc-400 hover:text-white"><X className="w-5 h-5" /></button>
                    </div>

                    <div className="flex-1 p-6 overflow-y-auto">
                        <div className="text-center mb-10 mt-4">
                            <div className="text-zinc-500 text-sm mb-2">偷吃 / 破戒次数</div>
                            <div className={`text-6xl font-black text-white transition-transform duration-200 ${isAnimating ? 'scale-125 text-red-500' : ''}`}>{count}</div>
                        </div>

                        <div className="space-y-4">
                            <div className="bg-red-950/20 border border-red-900/30 p-5 rounded-2xl flex items-center gap-4">
                                <div className="p-3 bg-red-900/20 rounded-xl text-red-500"><Activity className="w-6 h-6" /></div>
                                <div>
                                    <div className={`text-2xl font-bold text-red-400 font-mono ${isAnimating ? 'animate-pop-red' : ''}`}>{runDebtKm.toFixed(1)} <span className="text-sm">km</span></div>
                                    <div className="text-xs text-red-500/60 font-bold uppercase">运动债 (需跑步抵消)</div>
                                </div>
                            </div>

                            <div className="bg-zinc-800/30 border border-zinc-700/30 p-5 rounded-2xl flex items-center gap-4">
                                <div className="p-3 bg-zinc-700/30 rounded-xl text-zinc-400"><Flame className="w-6 h-6" /></div>
                                <div>
                                    <div className={`text-2xl font-bold text-zinc-300 font-mono ${isAnimating ? 'animate-pop-red' : ''}`}>{caloriesIntake} <span className="text-sm">Kcal</span></div>
                                    <div className="text-xs text-zinc-500 font-bold uppercase">无效热量摄入</div>
                                </div>
                            </div>

                            <div className="bg-orange-950/20 border border-orange-900/30 p-5 rounded-2xl flex items-center gap-4">
                                <div className="p-3 bg-orange-900/20 rounded-xl text-orange-500"><Wallet className="w-6 h-6" /></div>
                                <div>
                                    <div className={`text-2xl font-bold text-orange-400 font-mono ${isAnimating ? 'animate-pop-red' : ''}`}>¥{moneyLost.toFixed(0)}</div>
                                    <div className="text-xs text-orange-500/60 font-bold uppercase">浪费资金</div>
                                </div>
                            </div>
                        </div>

                        <div className="mt-12 text-center">
                            <p className="text-zinc-600 text-xs mb-4">这就去跑个步把这一顿抵消掉吧，不亏。</p>
                            <button 
                                onClick={handleAdd}
                                className="w-full bg-red-600 hover:bg-red-500 active:bg-red-700 text-white font-bold py-5 rounded-xl shadow-[0_0_30px_rgba(220,38,38,0.3)] flex items-center justify-center gap-2 transition-all active:scale-95"
                            >
                                <AlertCircle className="w-5 h-5" />
                                确认记录 (+1)
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 4. 欢迎页面 ---
        const Onboarding = ({ itemPrice, setItemPrice, itemCalories, setItemCalories, freqPerDay, setFreqPerDay, wishItem, setWishItem, wishCost, setWishCost, onStart }) => {
            return (
                <div className="min-h-screen bg-zinc-950 text-emerald-400 p-6 flex flex-col items-center font-mono overflow-y-auto safe-top safe-bottom">
                    <div className="w-full max-w-sm py-10 space-y-6">
                        <h1 className="text-3xl font-bold mb-2 tracking-tighter text-white text-center">身材夺回计划</h1>
                        <div className="space-y-4">
                            <div><label className="text-xs text-zinc-500 font-bold">你要戒什么? (参考价格)</label><input type="number" placeholder="一杯奶茶钱 (¥)" value={itemPrice} onChange={(e)=>setItemPrice(Number(e.target.value))} className="w-full bg-zinc-900 border border-zinc-700 p-4 rounded-xl text-white mt-2 outline-none"/></div>
                            <div><label className="text-xs text-zinc-500 font-bold">平均每次热量 (Kcal)</label><input type="number" placeholder="例如: 300" value={itemCalories} onChange={(e)=>setItemCalories(Number(e.target.value))} className="w-full bg-zinc-900 border border-zinc-700 p-4 rounded-xl text-white mt-2 outline-none"/></div>
                            <div><label className="text-xs text-zinc-500 font-bold">以前每天吃/喝几次?</label><input type="number" value={freqPerDay} onChange={(e)=>setFreqPerDay(Number(e.target.value))} className="w-full bg-zinc-900 border border-zinc-700 p-4 rounded-xl text-white mt-2 outline-none"/></div>
                            <div><label className="text-xs text-zinc-500 font-bold">瘦下来奖励自己什么?</label><input type="text" value={wishItem} onChange={(e)=>setWishItem(e.target.value)} className="w-full bg-zinc-900 border border-zinc-700 p-4 rounded-xl text-white mt-2 outline-none"/></div>
                            <div><label className="text-xs text-zinc-500 font-bold">奖励价格 (¥)</label><input type="number" value={wishCost} onChange={(e)=>setWishCost(Number(e.target.value))} className="w-full bg-zinc-900 border border-zinc-700 p-4 rounded-xl text-white mt-2 outline-none"/></div>
                        </div>
                        <button onClick={onStart} className="w-full mt-8 bg-emerald-600 text-black font-bold py-4 rounded-xl text-lg">开启减脂模式</button>
                    </div>
                </div>
            );
        };

        // --- 5. 仪表盘 ---
        const Dashboard = ({ onManualResist, stats, animateStats, wishItem, wishProgress, wishCost, itemPrice, freqPerDay }) => {
            return (
                <div className="p-4 space-y-5 pb-32 animate-in slide-in-from-bottom-4 duration-500">
                    <button onClick={onManualResist} className="w-full bg-gradient-to-r from-emerald-900 to-zinc-900 border border-emerald-500/30 p-4 rounded-2xl flex items-center justify-between group active:scale-95 transition-all shadow-[0_4px_20px_-5px_rgba(16,185,129,0.2)]">
                        <div className="flex items-center gap-3">
                            <div className="bg-emerald-500/20 p-3 rounded-full text-emerald-400 group-active:animate-bounce"><Fist className="w-6 h-6" /></div>
                            <div className="text-left"><div className="text-emerald-400 font-bold text-lg">刚才忍住没吃!</div><div className="text-zinc-500 text-xs">点击立即结算热量收益</div></div>
                        </div>
                        <div className="text-emerald-500/50 group-hover:text-emerald-400 group-active:translate-x-1 transition-all"><TrendingUp className="w-6 h-6" /></div>
                    </button>

                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-zinc-900 p-5 rounded-2xl border border-zinc-800 relative overflow-hidden">
                            <div className="text-zinc-500 text-xs uppercase mb-2 flex items-center font-bold tracking-wider"><Wallet className="w-3 h-3 mr-1.5"/> 夺回资金</div>
                            <div className={`text-3xl font-mono text-emerald-400 font-bold tracking-tighter transition-transform ${animateStats ? 'animate-pop-green' : ''}`}>¥{stats.money.toFixed(1)}</div>
                        </div>
                        <div className="bg-zinc-900 p-5 rounded-2xl border border-zinc-800">
                            <div className="text-zinc-500 text-xs uppercase mb-2 flex items-center font-bold tracking-wider"><Scale className="w-3 h-3 mr-1.5"/> 少长肥肉</div>
                            <div className={`text-3xl font-mono text-blue-400 font-bold tracking-tighter transition-transform ${animateStats ? 'animate-pop-green' : ''}`}>{stats.fatAvoided}<span className="text-sm text-zinc-500 ml-1">g</span></div>
                            <div className="text-[10px] text-zinc-600 mt-1">根据热量估算</div>
                        </div>
                    </div>

                    <div className="bg-zinc-900 rounded-2xl p-6 border border-zinc-800 relative overflow-hidden shadow-lg">
                        <div className="flex justify-between items-end mb-3 relative z-10">
                            <div><div className="text-xs text-zinc-500 uppercase font-bold mb-1">目标奖励</div><div className="text-2xl font-bold text-white tracking-tight">{wishItem}</div></div>
                            <div className="text-emerald-500 font-mono text-xl font-bold">{Math.min(100, wishProgress).toFixed(1)}%</div>
                        </div>
                        <div className="w-full h-5 bg-zinc-950 rounded-full overflow-hidden mt-2 border border-zinc-800/50 relative z-10">
                            <div className="h-full bg-gradient-to-r from-emerald-900 to-emerald-500 transition-all duration-1000" style={{width: `${wishProgress}%`}}></div>
                        </div>
                        <div className="mt-3 text-right text-xs text-zinc-500 font-mono relative z-10">还需 {Math.max(0, Math.ceil((wishCost - stats.money) / (itemPrice * freqPerDay)))} 天解锁</div>
                    </div>

                    <div className="grid grid-cols-3 gap-3">
                         <div className="bg-zinc-900 p-3 rounded-2xl border border-zinc-800 text-center">
                            <Flame className="w-5 h-5 text-orange-400 mx-auto mb-2" />
                            <div className={`font-bold text-zinc-200 text-lg transition-transform ${animateStats ? 'animate-pop-green' : ''}`}>{stats.caloriesBlocked}</div>
                            <div className="text-[10px] text-zinc-600">阻断热量 (Kcal)</div>
                        </div>
                         <div className="bg-zinc-900 p-3 rounded-2xl border border-zinc-800 text-center">
                            <Pizza className="w-5 h-5 text-zinc-400 mx-auto mb-2" />
                            <div className={`font-bold text-zinc-200 text-lg transition-transform ${animateStats ? 'animate-pop-green' : ''}`}>{stats.countAvoided}<span className="text-xs font-normal text-zinc-500">次</span></div>
                            <div className="text-[10px] text-zinc-600">拒绝暴食</div>
                        </div>
                         <div className="bg-zinc-900 p-3 rounded-2xl border border-zinc-800 text-center">
                            <Footprints className="w-5 h-5 text-teal-400 mx-auto mb-2" />
                            <div className={`font-bold text-zinc-200 text-lg transition-transform ${animateStats ? 'animate-pop-green' : ''}`}>{stats.runDistanceSaved.toFixed(1)}<span className="text-xs font-normal text-zinc-500">km</span></div>
                            <div className="text-[10px] text-zinc-600">免跑距离</div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 6. 设置页面 ---
        const SettingsTab = ({ wishItem, setWishItem, wishCost, setWishCost, itemPrice, setItemPrice, itemCalories, setItemCalories, manualResistCount, setManualResistCount }) => {
            return (
                <div className="p-6 space-y-6 text-white pb-32 animate-in slide-in-from-right-4 duration-300">
                    <h2 className="text-2xl font-bold mb-6 tracking-tight">配置计划</h2>
                    <div className="space-y-6">
                        <div><label className="text-xs text-zinc-500 font-bold">目标物品</label><input type="text" value={wishItem} onChange={(e) => setWishItem(e.target.value)} className="w-full bg-zinc-900 p-4 rounded-xl border border-zinc-800 mt-2 outline-none" /></div>
                        <div><label className="text-xs text-zinc-500 font-bold">目标价格</label><input type="number" value={wishCost} onChange={(e) => setWishCost(Number(e.target.value))} className="w-full bg-zinc-900 p-4 rounded-xl border border-zinc-800 mt-2 outline-none" /></div>
                        
                        <div className="bg-zinc-900 p-4 rounded-xl border border-zinc-800 mt-4">
                            <div className="text-xs font-bold text-zinc-400 mb-4 uppercase">基准参数</div>
                            <div className="space-y-4">
                                <div><label className="text-xs text-zinc-500">单次价格 (¥)</label><input type="number" value={itemPrice} onChange={(e)=>setItemPrice(Number(e.target.value))} className="w-full bg-zinc-950 p-3 rounded mt-1 border border-zinc-800 text-sm"/></div>
                                <div><label className="text-xs text-zinc-500">单次热量 (Kcal)</label><input type="number" value={itemCalories} onChange={(e)=>setItemCalories(Number(e.target.value))} className="w-full bg-zinc-950 p-3 rounded mt-1 border border-zinc-800 text-sm"/></div>
                            </div>
                        </div>

                        <div className="bg-zinc-900 p-4 rounded-xl border border-zinc-800">
                            <div className="text-xs font-bold text-zinc-400 mb-2 uppercase">数据修正</div>
                            <div className="flex justify-between items-center"><span className="text-sm text-zinc-300">主动忍住次数: {manualResistCount}</span><button onClick={() => setManualResistCount(0)} className="text-xs bg-zinc-800 px-3 py-1 rounded text-zinc-400">重置</button></div>
                        </div>
                        <div className="pt-8 border-t border-zinc-800">
                            <button onClick={() => { if(confirm("确定要全部重置吗？")) { localStorage.clear(); window.location.reload(); } }} className="w-full bg-red-950/30 text-red-400 p-4 rounded-xl border border-red-900/30 hover:bg-red-900/40 font-bold text-sm">重置所有记录</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 7. APP 主程序 ---
        const App = () => {
            const [setupComplete, setSetupComplete] = useState(false);
            const [startDate, setStartDate] = useState(null);
            const [itemPrice, setItemPrice] = useState(20); 
            const [itemCalories, setItemCalories] = useState(300); 
            const [freqPerDay, setFreqPerDay] = useState(1); 
            const [wishItem, setWishItem] = useState("Lululemon瑜伽服");
            const [wishCost, setWishCost] = useState(1000);
            const [slipUps, setSlipUps] = useState([]);
            const [manualResistCount, setManualResistCount] = useState(0); 
            
            // 喝水数据
            const [waterIntake, setWaterIntake] = useState(0);
            const [lastWaterDate, setLastWaterDate] = useState(null);

            const [showVape, setShowVape] = useState(false);
            const [showDamageReport, setShowDamageReport] = useState(false);
            const [showHydration, setShowHydration] = useState(false); // 新增状态
            const [activeTab, setActiveTab] = useState('dashboard');
            const [animateStats, setAnimateStats] = useState(false);
            const [error, setError] = useState(null);
            
            useEffect(() => {
                const savedData = localStorage.getItem('reclaim_diet_data_v3');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed) {
                            if (parsed.setupComplete !== undefined) setSetupComplete(parsed.setupComplete);
                            setStartDate(parsed.startDate);
                            setItemPrice(parsed.itemPrice);
                            if (parsed.itemCalories) setItemCalories(parsed.itemCalories);
                            setFreqPerDay(parsed.freqPerDay);
                            setWishItem(parsed.wishItem);
                            setWishCost(parsed.wishCost);
                            setSlipUps(parsed.slipUps || []);
                            setManualResistCount(parsed.manualResistCount || 0);
                            
                            // 检查喝水日期，如果不是今天则重置
                            const todayStr = new Date().toDateString();
                            if (parsed.lastWaterDate !== todayStr) {
                                setWaterIntake(0);
                                setLastWaterDate(todayStr);
                            } else {
                                setWaterIntake(parsed.waterIntake || 0);
                                setLastWaterDate(parsed.lastWaterDate);
                            }
                        }
                    } catch (e) {
                        console.error("Data Load Error", e);
                        setError("数据读取失败，请点击下方重置按钮");
                    }
                } else {
                    setLastWaterDate(new Date().toDateString());
                }
            }, []);

            useEffect(() => {
                try {
                    const data = { 
                        setupComplete, startDate, itemPrice, itemCalories, freqPerDay, 
                        wishItem, wishCost, slipUps, manualResistCount,
                        waterIntake, lastWaterDate 
                    };
                    localStorage.setItem('reclaim_diet_data_v3', JSON.stringify(data));
                } catch(e) { console.error("Save Error", e); }
            }, [setupComplete, startDate, itemPrice, itemCalories, freqPerDay, wishItem, wishCost, slipUps, manualResistCount, waterIntake, lastWaterDate]);

            // 核心计算 (Diet Metrics)
            const calculateStats = () => {
                try {
                    if (!startDate) return { days: 0, money: 0, countAvoided: 0, slipUps: 0, caloriesBlocked: 0, fatAvoided: 0, runDistanceSaved: 0 };
                    const now = new Date().getTime();
                    const start = new Date(startDate).getTime();
                    const diffTime = Math.abs(now - start);
                    const diffDays = diffTime / (1000 * 60 * 60 * 24);
                    
                    const autoAvoided = diffDays * freqPerDay;
                    const slipUpsLength = Array.isArray(slipUps) ? slipUps.length : 0;
                    const totalAvoided = Math.max(0, autoAvoided + manualResistCount - slipUpsLength);
                    
                    const moneySaved = totalAvoided * itemPrice;
                    const caloriesBlocked = totalAvoided * itemCalories;
                    const fatAvoided = (caloriesBlocked / 7700) * 1000; 
                    const runDistanceSaved = caloriesBlocked / 65; 
                    
                    return { 
                        days: diffDays, money: moneySaved, countAvoided: Math.floor(totalAvoided), 
                        slipUps: slipUpsLength, caloriesBlocked: Math.floor(caloriesBlocked), 
                        fatAvoided: Math.floor(fatAvoided), runDistanceSaved: runDistanceSaved
                    };
                } catch (err) {
                    return { days: 0, money: 0, countAvoided: 0, slipUps: 0, caloriesBlocked: 0, fatAvoided: 0, runDistanceSaved: 0 };
                }
            };

            const stats = calculateStats();
            const wishProgress = Math.min(100, (stats.money / wishCost) * 100);

            const handleManualResist = () => {
                setManualResistCount(c => c + 1);
                setAnimateStats(true);
                setTimeout(() => setAnimateStats(false), 200);
                if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
            };

            const handleStart = () => {
                setStartDate(new Date().getTime());
                setSetupComplete(true);
            };

            const handleConfirmSlipUp = () => {
                setSlipUps([...slipUps, new Date().getTime()]);
                if (navigator.vibrate) navigator.vibrate(200);
            };

            const handleDrink = (amount) => {
                const newIntake = waterIntake + amount;
                setWaterIntake(newIntake);
                // 确保日期是今天
                setLastWaterDate(new Date().toDateString());
                if (navigator.vibrate) navigator.vibrate(50);
            };

            if (error) {
                return (
                    <div className="min-h-screen bg-black text-white flex flex-col items-center justify-center p-8">
                        <AlertCircle className="w-16 h-16 text-red-500 mb-4" />
                        <h2 className="text-xl font-bold mb-2">数据加载异常</h2>
                        <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="bg-red-600 text-white px-6 py-3 rounded-xl font-bold mt-4">强制重置数据</button>
                    </div>
                );
            }

            if (!setupComplete) return (
                <Onboarding 
                    itemPrice={itemPrice} setItemPrice={setItemPrice}
                    itemCalories={itemCalories} setItemCalories={setItemCalories}
                    freqPerDay={freqPerDay} setFreqPerDay={setFreqPerDay}
                    wishItem={wishItem} setWishItem={setWishItem}
                    wishCost={wishCost} setWishCost={setWishCost}
                    onStart={handleStart}
                />
            );

            return (
                <div className="bg-zinc-950 min-h-screen text-zinc-100 font-sans selection:bg-emerald-500/30 overflow-hidden">
                    {showVape && <CyberSuppressor onClose={() => setShowVape(false)} />}
                    {showDamageReport && <DamageReport onClose={() => setShowDamageReport(false)} slipUps={slipUps} itemPrice={itemPrice} itemCalories={itemCalories} onConfirmSlipUp={handleConfirmSlipUp} />}
                    {showHydration && <HydrationStation onClose={() => setShowHydration(false)} waterIntake={waterIntake} onDrink={handleDrink} />}

                    <div className="fixed top-0 left-0 right-0 z-20 bg-zinc-950/90 backdrop-blur-xl border-b border-zinc-800/50 p-4 flex justify-between items-center safe-top">
                        <div><h1 className="font-bold text-lg tracking-tight flex items-center">RECLAIM <span className="bg-emerald-500/10 text-emerald-500 text-[10px] px-1.5 py-0.5 rounded ml-2 border border-emerald-500/20">DIET</span></h1><p className="text-xs text-zinc-500 font-mono mt-0.5">DAY {Math.floor(stats.days)}</p></div>
                        <button onClick={() => setShowDamageReport(true)} className="text-xs bg-red-900/20 active:bg-red-900/40 text-red-400 px-4 py-2 rounded-full border border-red-900/30 transition-colors font-medium flex items-center gap-1"><AlertCircle className="w-3 h-3" /> 破戒/偷吃</button>
                    </div>
                    <div className="h-screen overflow-y-auto pt-20 max-w-md mx-auto no-scrollbar">
                        {activeTab === 'dashboard' ? (
                            <Dashboard 
                                onManualResist={handleManualResist}
                                stats={stats}
                                animateStats={animateStats}
                                wishItem={wishItem}
                                wishProgress={wishProgress}
                                wishCost={wishCost}
                                itemPrice={itemPrice}
                                freqPerDay={freqPerDay}
                            />
                        ) : (
                            <SettingsTab 
                                wishItem={wishItem} setWishItem={setWishItem}
                                wishCost={wishCost} setWishCost={setWishCost}
                                itemPrice={itemPrice} setItemPrice={setItemPrice}
                                itemCalories={itemCalories} setItemCalories={setItemCalories}
                                manualResistCount={manualResistCount} setManualResistCount={setManualResistCount}
                            />
                        )}
                    </div>
                    
                    {/* 底部悬浮按钮组 */}
                    <div className="fixed bottom-24 w-full px-6 flex justify-between items-end z-30 pointer-events-none safe-bottom-pad">
                        {/* 左侧：喝水鸭子 */}
                        <button 
                            onClick={() => setShowHydration(true)} 
                            className="pointer-events-auto bg-sky-600 hover:bg-sky-500 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center active:scale-90 transition-all border border-sky-400"
                        >
                            <Droplet className="w-5 h-5 text-white" />
                        </button>

                        {/* 右侧：抑制食欲 */}
                        <button 
                            onClick={() => setShowVape(true)} 
                            className="pointer-events-auto bg-zinc-800 hover:bg-zinc-700 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center active:scale-90 transition-all border border-zinc-700"
                        >
                            <Zap className="w-5 h-5 text-emerald-400" />
                        </button>
                    </div>

                    <div className="fixed bottom-0 left-0 w-full bg-zinc-950/90 backdrop-blur-lg border-t border-zinc-800 p-2 pb-6 flex justify-around items-center z-40 safe-bottom">
                        <button onClick={() => setActiveTab('dashboard')} className={`p-3 rounded-2xl flex flex-col items-center gap-1 w-20 transition-all ${activeTab === 'dashboard' ? 'text-emerald-400' : 'text-zinc-600'}`}><TrendingUp className="w-6 h-6" /><span className="text-[10px] font-bold">控制台</span></button>
                        <button onClick={() => setActiveTab('settings')} className={`p-3 rounded-2xl flex flex-col items-center gap-1 w-20 transition-all ${activeTab === 'settings' ? 'text-emerald-400' : 'text-zinc-600'}`}><Settings className="w-6 h-6" /><span className="text-[10px] font-bold">配置</span></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>